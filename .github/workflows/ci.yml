# CI æµç¨‹ - Pull Request è‡ªåŠ¨æ£€æµ‹
# ä»…åœ¨ PR è¿è¡Œï¼Œmain åˆ†æ”¯ç”± docker-publish æ‰§è¡Œå‘å¸ƒæ„å»º

name: CI

on:
  pull_request:
    branches: [main]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'docker-compose.yml'

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== æ ¸å¿ƒæ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰====================
  check:
    name: âœ… ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8
      
      - name: ğŸ è¯­æ³•æ£€æŸ¥
        run: |
          python -m py_compile main.py src/config.py src/analyzer.py src/notification.py
          python -m py_compile src/storage.py src/scheduler.py src/search_service.py
          python -m py_compile src/market_analyzer.py src/stock_analyzer.py
          python -m py_compile data_provider/*.py
          echo "âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡"
      
      - name: ğŸ” é™æ€åˆ†æ (ä¸¥é‡é”™è¯¯)
        run: |
          # åªæ£€æŸ¥ä¸¥é‡é”™è¯¯ï¼šè¯­æ³•é”™è¯¯ã€æœªå®šä¹‰å˜é‡ç­‰
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•
        run: |
          python -c "from src.config import get_config; print('âœ… config')"
          python -c "from src.storage import DatabaseManager; print('âœ… storage')"
          python -c "from src.notification import NotificationService; print('âœ… notification')"
          python -c "from data_provider import DataFetcherManager; print('âœ… data_provider')"
          python -c "from src.analyzer import GeminiAnalyzer; print('âœ… analyzer')"
          echo "âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ"

  # ==================== Docker æ„å»ºæµ‹è¯• ====================
  docker:
    name: ğŸ³ Docker æ„å»º
    runs-on: ubuntu-latest
    needs: [check]
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ³ æ„å»ºé•œåƒ
        run: |
          docker build -t stock-analysis:test -f docker/Dockerfile .
          docker run --rm stock-analysis:test python -c "print('âœ… Docker OK')"
