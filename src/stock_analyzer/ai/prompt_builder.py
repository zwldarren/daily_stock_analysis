"""
æç¤ºè¯æ„å»ºæ¨¡å—

è´Ÿè´£æ„å»ºå‘é€ç»™AIçš„åˆ†ææç¤ºè¯
"""

from typing import Any

from stock_analyzer.domain import get_stock_name_from_context
from stock_analyzer.technical.formatter import ResultFormatter


class PromptBuilder:
    """æç¤ºè¯æ„å»ºå™¨"""

    @staticmethod
    def build_analysis_prompt(context: dict[str, Any], name: str, news_context: str | None = None) -> str:
        """
        æ„å»ºè‚¡ç¥¨åˆ†ææç¤ºè¯ï¼ˆå†³ç­–ä»ªè¡¨ç›˜ v2.0ï¼‰

        åŒ…å«ï¼šæŠ€æœ¯æŒ‡æ ‡ã€å®æ—¶è¡Œæƒ…ï¼ˆé‡æ¯”/æ¢æ‰‹ç‡ï¼‰ã€ç­¹ç åˆ†å¸ƒã€è¶‹åŠ¿åˆ†æã€æ–°é—»

        Args:
            context: æŠ€æœ¯é¢æ•°æ®ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å¢å¼ºæ•°æ®ï¼‰
            name: è‚¡ç¥¨åç§°ï¼ˆé»˜è®¤å€¼ï¼Œå¯èƒ½è¢«ä¸Šä¸‹æ–‡è¦†ç›–ï¼‰
            news_context: é¢„å…ˆæœç´¢çš„æ–°é—»å†…å®¹
        """
        code = context.get("code", "Unknown")

        # ä¼˜å…ˆä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„è‚¡ç¥¨åç§°
        stock_name = context.get("stock_name", name)
        if not stock_name or stock_name == f"è‚¡ç¥¨{code}":
            stock_name = get_stock_name_from_context(code, context)

        today = context.get("today", {}).copy()

        # å¦‚æœæœ‰å®æ—¶è¡Œæƒ…æ•°æ®ï¼Œç”¨å®æ—¶ä»·æ ¼è¦†ç›–å†å²æ•°æ®
        if "realtime" in context:
            rt = context["realtime"]
            if rt.get("price"):
                today["close"] = rt.get("price")
            if rt.get("change_percent"):
                today["pct_chg"] = rt.get("change_percent")

        # æ„å»ºå†³ç­–ä»ªè¡¨ç›˜æ ¼å¼çš„è¾“å…¥
        prompt = f"""# å†³ç­–ä»ªè¡¨ç›˜åˆ†æè¯·æ±‚

## ğŸ“Š è‚¡ç¥¨åŸºç¡€ä¿¡æ¯
| é¡¹ç›® | æ•°æ® |
|------|------|
| è‚¡ç¥¨ä»£ç  | **{code}** |
| è‚¡ç¥¨åç§° | **{stock_name}** |
| åˆ†ææ—¥æœŸ | {context.get("date", "æœªçŸ¥")} |

---

## ğŸ“ˆ æŠ€æœ¯é¢æ•°æ®

### ä»Šæ—¥è¡Œæƒ…
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ”¶ç›˜ä»· | {today.get("close", "N/A")} å…ƒ |
| å¼€ç›˜ä»· | {today.get("open", "N/A")} å…ƒ |
| æœ€é«˜ä»· | {today.get("high", "N/A")} å…ƒ |
| æœ€ä½ä»· | {today.get("low", "N/A")} å…ƒ |
| æ¶¨è·Œå¹… | {today.get("pct_chg", "N/A")}% |
| æˆäº¤é‡ | {ResultFormatter.format_volume(today.get("volume"))} |
| æˆäº¤é¢ | {ResultFormatter.format_amount(today.get("amount"))} |

### å‡çº¿ç³»ç»Ÿï¼ˆå…³é”®åˆ¤æ–­æŒ‡æ ‡ï¼‰
| å‡çº¿ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| MA5 | {today.get("ma5", "N/A")} | çŸ­æœŸè¶‹åŠ¿çº¿ |
| MA10 | {today.get("ma10", "N/A")} | ä¸­çŸ­æœŸè¶‹åŠ¿çº¿ |
| MA20 | {today.get("ma20", "N/A")} | ä¸­æœŸè¶‹åŠ¿çº¿ |
| å‡çº¿å½¢æ€ | {context.get("ma_status", "æœªçŸ¥")} | å¤šå¤´/ç©ºå¤´/ç¼ ç»• |
"""

        # æ·»åŠ å®æ—¶è¡Œæƒ…æ•°æ®
        if "realtime" in context:
            rt = context["realtime"]
            prompt += f"""
### å®æ—¶è¡Œæƒ…å¢å¼ºæ•°æ®
| æŒ‡æ ‡ | æ•°å€¼ | è§£è¯» |
|------|------|------|
| å½“å‰ä»·æ ¼ | {rt.get("price", "N/A")} å…ƒ | |
| **é‡æ¯”** | **{rt.get("volume_ratio", "N/A")}** | {rt.get("volume_ratio_desc", "")} |
| **æ¢æ‰‹ç‡** | **{rt.get("turnover_rate", "N/A")}%** | |
| å¸‚ç›ˆç‡(åŠ¨æ€) | {rt.get("pe_ratio", "N/A")} | |
| å¸‚å‡€ç‡ | {rt.get("pb_ratio", "N/A")} | |
| æ€»å¸‚å€¼ | {ResultFormatter.format_amount(rt.get("total_mv"))} | |
| æµé€šå¸‚å€¼ | {ResultFormatter.format_amount(rt.get("circ_mv"))} | |
| 60æ—¥æ¶¨è·Œå¹… | {rt.get("change_60d", "N/A")}% | ä¸­æœŸè¡¨ç° |
"""

        # æ·»åŠ ç­¹ç åˆ†å¸ƒæ•°æ®
        if "chip" in context:
            chip = context["chip"]
            profit_ratio = chip.get("profit_ratio", 0)
            prompt += f"""
### ç­¹ç åˆ†å¸ƒæ•°æ®ï¼ˆæ•ˆç‡æŒ‡æ ‡ï¼‰
| æŒ‡æ ‡ | æ•°å€¼ | å¥åº·æ ‡å‡† |
|------|------|----------|
| **è·åˆ©æ¯”ä¾‹** | **{profit_ratio:.1%}** | 70-90%æ—¶è­¦æƒ• |
| å¹³å‡æˆæœ¬ | {chip.get("avg_cost", "N/A")} å…ƒ | ç°ä»·åº”é«˜äº5-15% |
| 90%ç­¹ç é›†ä¸­åº¦ | {chip.get("concentration_90", 0):.2%} | <15%ä¸ºé›†ä¸­ |
| 70%ç­¹ç é›†ä¸­åº¦ | {chip.get("concentration_70", 0):.2%} | |
| ç­¹ç çŠ¶æ€ | {chip.get("chip_status", "æœªçŸ¥")} | |
"""

        # æ·»åŠ è¶‹åŠ¿åˆ†æç»“æœ
        if "trend_analysis" in context:
            trend = context["trend_analysis"]
            bias_warning = "ğŸš¨ è¶…è¿‡5%ï¼Œä¸¥ç¦è¿½é«˜ï¼" if trend.get("bias_ma5", 0) > 5 else "âœ… å®‰å…¨èŒƒå›´"
            prompt += f"""
### è¶‹åŠ¿åˆ†æé¢„åˆ¤ï¼ˆåŸºäºäº¤æ˜“ç†å¿µï¼‰
| æŒ‡æ ‡ | æ•°å€¼ | åˆ¤å®š |
|------|------|------|
| è¶‹åŠ¿çŠ¶æ€ | {trend.get("trend_status", "æœªçŸ¥")} | |
| å‡çº¿æ’åˆ— | {trend.get("ma_alignment", "æœªçŸ¥")} | MA5>MA10>MA20ä¸ºå¤šå¤´ |
| è¶‹åŠ¿å¼ºåº¦ | {trend.get("trend_strength", 0)}/100 | |
| **ä¹–ç¦»ç‡(MA5)** | **{trend.get("bias_ma5", 0):+.2f}%** | {bias_warning} |
| ä¹–ç¦»ç‡(MA10) | {trend.get("bias_ma10", 0):+.2f}% | |
| é‡èƒ½çŠ¶æ€ | {trend.get("volume_status", "æœªçŸ¥")} | {trend.get("volume_trend", "")} |
| ç³»ç»Ÿä¿¡å· | {trend.get("buy_signal", "æœªçŸ¥")} | |
| ç³»ç»Ÿè¯„åˆ† | {trend.get("signal_score", 0)}/100 | |

#### ç³»ç»Ÿåˆ†æç†ç”±
**ä¹°å…¥ç†ç”±**ï¼š
{chr(10).join("- " + r for r in trend.get("signal_reasons", ["æ— "])) if trend.get("signal_reasons") else "- æ— "}

**é£é™©å› ç´ **ï¼š
{chr(10).join("- " + r for r in trend.get("risk_factors", ["æ— "])) if trend.get("risk_factors") else "- æ— "}
"""

        # æ·»åŠ æ˜¨æ—¥å¯¹æ¯”æ•°æ®
        if "yesterday" in context:
            volume_change = context.get("volume_change_ratio", "N/A")
            prompt += f"""
### é‡ä»·å˜åŒ–
- æˆäº¤é‡è¾ƒæ˜¨æ—¥å˜åŒ–ï¼š{volume_change}å€
- ä»·æ ¼è¾ƒæ˜¨æ—¥å˜åŒ–ï¼š{context.get("price_change_ratio", "N/A")}%
"""

        # æ·»åŠ æ–°é—»æœç´¢ç»“æœ
        prompt += """
---

## ğŸ“° èˆ†æƒ…æƒ…æŠ¥
"""
        if news_context:
            prompt += f"""
ä»¥ä¸‹æ˜¯ **{stock_name}({code})** è¿‘7æ—¥çš„æ–°é—»æœç´¢ç»“æœï¼Œè¯·é‡ç‚¹æå–ï¼š
1. ğŸš¨ **é£é™©è­¦æŠ¥**ï¼šå‡æŒã€å¤„ç½šã€åˆ©ç©º
2. ğŸ¯ **åˆ©å¥½å‚¬åŒ–**ï¼šä¸šç»©ã€åˆåŒã€æ”¿ç­–
3. ğŸ“Š **ä¸šç»©é¢„æœŸ**ï¼šå¹´æŠ¥é¢„å‘Šã€ä¸šç»©å¿«æŠ¥

```
{news_context}
```
"""
        else:
            prompt += """
æœªæœç´¢åˆ°è¯¥è‚¡ç¥¨è¿‘æœŸçš„ç›¸å…³æ–°é—»ã€‚è¯·ä¸»è¦ä¾æ®æŠ€æœ¯é¢æ•°æ®è¿›è¡Œåˆ†æã€‚
"""

        # æ³¨å…¥ç¼ºå¤±æ•°æ®è­¦å‘Š
        if context.get("data_missing"):
            prompt += """
âš ï¸ **æ•°æ®ç¼ºå¤±è­¦å‘Š**
ç”±äºæ¥å£é™åˆ¶ï¼Œå½“å‰æ— æ³•è·å–å®Œæ•´çš„å®æ—¶è¡Œæƒ…å’ŒæŠ€æœ¯æŒ‡æ ‡æ•°æ®ã€‚
è¯· **å¿½ç•¥ä¸Šè¿°è¡¨æ ¼ä¸­çš„ N/A æ•°æ®**ï¼Œé‡ç‚¹ä¾æ® **ã€ğŸ“° èˆ†æƒ…æƒ…æŠ¥ã€‘** ä¸­çš„æ–°é—»è¿›è¡ŒåŸºæœ¬é¢å’Œæƒ…ç»ªé¢åˆ†æã€‚
åœ¨å›ç­”æŠ€æœ¯é¢é—®é¢˜ï¼ˆå¦‚å‡çº¿ã€ä¹–ç¦»ç‡ï¼‰æ—¶ï¼Œè¯·ç›´æ¥è¯´æ˜"æ•°æ®ç¼ºå¤±ï¼Œæ— æ³•åˆ¤æ–­"ï¼Œ**ä¸¥ç¦ç¼–é€ æ•°æ®**ã€‚
"""

        # æ˜ç¡®çš„è¾“å‡ºè¦æ±‚
        prompt += f"""
---

## âœ… åˆ†æä»»åŠ¡

è¯·ä¸º **{stock_name}({code})** ç”Ÿæˆã€å†³ç­–ä»ªè¡¨ç›˜ã€‘ï¼Œä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼è¾“å‡ºã€‚

### âš ï¸ é‡è¦ï¼šè‚¡ç¥¨åç§°ç¡®è®¤
å¦‚æœä¸Šæ–¹æ˜¾ç¤ºçš„è‚¡ç¥¨åç§°ä¸º"è‚¡ç¥¨{code}"æˆ–ä¸æ­£ç¡®ï¼Œè¯·åœ¨åˆ†æå¼€å¤´**æ˜ç¡®è¾“å‡ºè¯¥è‚¡ç¥¨çš„æ­£ç¡®ä¸­æ–‡å…¨ç§°**ã€‚

### é‡ç‚¹å…³æ³¨ï¼ˆå¿…é¡»æ˜ç¡®å›ç­”ï¼‰ï¼š
1. â“ æ˜¯å¦æ»¡è¶³ MA5>MA10>MA20 å¤šå¤´æ’åˆ—ï¼Ÿ
2. â“ å½“å‰ä¹–ç¦»ç‡æ˜¯å¦åœ¨å®‰å…¨èŒƒå›´å†…ï¼ˆ<5%ï¼‰ï¼Ÿâ€”â€” è¶…è¿‡5%å¿…é¡»æ ‡æ³¨"ä¸¥ç¦è¿½é«˜"
3. â“ é‡èƒ½æ˜¯å¦é…åˆï¼ˆç¼©é‡å›è°ƒ/æ”¾é‡çªç ´ï¼‰ï¼Ÿ
4. â“ ç­¹ç ç»“æ„æ˜¯å¦å¥åº·ï¼Ÿ
5. â“ æ¶ˆæ¯é¢æœ‰æ— é‡å¤§åˆ©ç©ºï¼Ÿï¼ˆå‡æŒã€å¤„ç½šã€ä¸šç»©å˜è„¸ç­‰ï¼‰

### å†³ç­–ä»ªè¡¨ç›˜è¦æ±‚ï¼š
- **è‚¡ç¥¨åç§°**ï¼šå¿…é¡»è¾“å‡ºæ­£ç¡®çš„ä¸­æ–‡å…¨ç§°ï¼ˆå¦‚"è´µå·èŒ…å°"è€Œé"è‚¡ç¥¨600519"ï¼‰
- **æ ¸å¿ƒç»“è®º**ï¼šä¸€å¥è¯è¯´æ¸…è¯¥ä¹°/è¯¥å–/è¯¥ç­‰
- **æŒä»“åˆ†ç±»å»ºè®®**ï¼šç©ºä»“è€…æ€ä¹ˆåš vs æŒä»“è€…æ€ä¹ˆåš
- **å…·ä½“ç‹™å‡»ç‚¹ä½**ï¼šä¹°å…¥ä»·ã€æ­¢æŸä»·ã€ç›®æ ‡ä»·ï¼ˆç²¾ç¡®åˆ°åˆ†ï¼‰
- **æ£€æŸ¥æ¸…å•**ï¼šæ¯é¡¹ç”¨ âœ…/âš ï¸/âŒ æ ‡è®°

è¯·è¾“å‡ºå®Œæ•´çš„ JSON æ ¼å¼å†³ç­–ä»ªè¡¨ç›˜ã€‚"""

        return prompt
